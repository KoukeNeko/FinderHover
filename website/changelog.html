<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>更新日誌 - FinderHover</title>
    <meta name="description" content="FinderHover 版本更新歷史與變更記錄。" />
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/png" href="assets/icon.png" />
    <script src="components.js" defer></script>
  </head>
  <body>
    <!-- Navigation -->
    <site-nav></site-nav>

    <!-- Changelog Hero -->
    <page-hero
      title="更新日誌"
      subtitle="追蹤 FinderHover 的每一次進化"
    ></page-hero>

    <!-- Changelog Content -->
    <section class="changelog-section">
      <div class="changelog-container" id="changelog-content">
        <!-- Loading State -->
        <div class="changelog-loading">
          <div class="loading-spinner"></div>
          <p>正在從 GitHub 載入更新日誌...</p>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <site-footer></site-footer>

    <script>
      // Fetch and parse CHANGELOG.md from GitHub
      async function loadChangelog() {
        const container = document.getElementById('changelog-content');
        const rawUrl = 'https://raw.githubusercontent.com/KoukeNeko/FinderHover/main/CHANGELOG.md';
        
        try {
          const response = await fetch(rawUrl);
          if (!response.ok) throw new Error('Failed to fetch changelog');
          
          const markdown = await response.text();
          const html = parseChangelog(markdown);
          container.innerHTML = html;
        } catch (error) {
          console.error('Error loading changelog:', error);
          container.innerHTML = `
            <div class="changelog-error">
              <p>無法載入更新日誌</p>
              <a href="https://github.com/KoukeNeko/FinderHover/blob/main/CHANGELOG.md" 
                 class="changelog-link" target="_blank">
                在 GitHub 上查看
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                  <polyline points="15 3 21 3 21 9"/>
                  <line x1="10" y1="14" x2="21" y2="3"/>
                </svg>
              </a>
            </div>
          `;
        }
      }

      function parseChangelog(markdown) {
        // Split by version headers (## [x.x.x])
        const versionRegex = /^## \[(\d+\.\d+\.\d+)\](?: - (\d{4}-\d{2}-\d{2}))?/gm;
        const versions = [];
        let match;
        let lastIndex = 0;
        
        // Find all version headers
        const matches = [...markdown.matchAll(versionRegex)];
        
        matches.forEach((match, i) => {
          const version = match[1];
          const date = match[2] || '';
          const startIndex = match.index + match[0].length;
          const endIndex = matches[i + 1]?.index || markdown.length;
          const content = markdown.slice(startIndex, endIndex).trim();
          
          versions.push({ version, date, content });
        });
        
        // Get the latest version from Info.plist or first in list
        const latestVersion = versions[0]?.version;
        
        // Convert to HTML
        let html = versions.map((v, index) => {
          const isMajor = v.version.endsWith('.0') && !v.version.endsWith('.0.0');
          const isLatest = index === 0;
          
          return `
            <article class="changelog-entry${isMajor ? ' major' : ''}">
              <div class="changelog-header">
                <span class="changelog-version">${v.version}</span>
                ${isLatest ? '<span class="changelog-badge current">目前版本</span>' : ''}
                ${isMajor && !isLatest ? '<span class="changelog-badge major">重大更新</span>' : ''}
                ${v.date ? `<span class="changelog-date">${v.date}</span>` : ''}
              </div>
              <div class="changelog-content">
                ${parseMarkdownContent(v.content)}
              </div>
            </article>
          `;
        }).join('');
        
        // Add footer
        html += `
          <div class="changelog-footer">
            <a href="https://github.com/KoukeNeko/FinderHover/blob/main/CHANGELOG.md" 
               class="changelog-link" target="_blank">
              在 GitHub 上查看完整更新日誌
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                <polyline points="15 3 21 3 21 9"/>
                <line x1="10" y1="14" x2="21" y2="3"/>
              </svg>
            </a>
          </div>
        `;
        
        return html;
      }

      function parseMarkdownContent(content) {
        // Parse markdown sections into HTML
        let html = content;
        
        // Convert ### headers to h3
        html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
        
        // Convert #### headers to h4
        html = html.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
        
        // Convert bullet points to list items
        // First, wrap consecutive list items in <ul>
        const lines = html.split('\n');
        let result = [];
        let inList = false;
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          const isListItem = line.trim().startsWith('- ');
          
          if (isListItem && !inList) {
            result.push('<ul>');
            inList = true;
          } else if (!isListItem && inList && line.trim() !== '') {
            result.push('</ul>');
            inList = false;
          }
          
          if (isListItem) {
            const text = line.trim().substring(2);
            // Convert inline code
            const escapedText = text
              .replace(/`([^`]+)`/g, '<code>$1</code>')
              .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            result.push(`<li>${escapedText}</li>`);
          } else if (line.trim() !== '' || !inList) {
            result.push(line);
          }
        }
        
        if (inList) {
          result.push('</ul>');
        }
        
        return result.join('\n');
      }

      // Load changelog when page loads
      document.addEventListener('DOMContentLoaded', loadChangelog);
    </script>

    <style>
      .changelog-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem 2rem;
        color: var(--text-secondary);
      }
      
      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      .changelog-error {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-secondary);
      }
      
      .changelog-error p {
        margin-bottom: 1rem;
      }
      
      .changelog-date {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-left: auto;
      }
    </style>
  </body>
</html>
